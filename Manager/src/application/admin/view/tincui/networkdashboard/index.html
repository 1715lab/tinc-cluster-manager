<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>内网数据可视化</title>
    <link rel="stylesheet" href="__CDN__/assets/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="__CDN__/assets/css/fastadmin.min.css"/>
    <link rel="stylesheet" href="__CDN__/assets/libs/font-awesome/css/font-awesome.min.css"/>
    <style>
        .network-dashboard {
            padding: 20px;
        }
        .network-selector {
            margin-bottom: 30px;
            background: #fff;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            text-align: center;
        }
        .selector-container {
            display: inline-block;
            margin: 0 10px;
        }
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        .card {
            background: #fff;
            border-radius: 5px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            text-align: center;
        }
        .card-title {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }
        .card-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        .card-trend {
            height: 50px;
            margin-top: 10px;
        }
        .charts-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        .chart-box {
            background: #fff;
            border-radius: 5px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            height: 400px;
        }
        .chart-title {
            color: #333;
            font-size: 16px;
            margin-bottom: 20px;
            text-align: center;
        }
        .chart {
            height: calc(100% - 40px);
            width: 100%;
        }
        .loading {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            font-size: 18px;
        }
        .traffic-details {
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
        }
        .traffic-item {
            text-align: center;
        }
        .traffic-label {
            font-size: 12px;
            color: #666;
        }
        .traffic-value {
            font-size: 16px;
            font-weight: bold;
        }
        .upload {
            color: #f56c6c;
        }
        .download {
            color: #67c23a;
        }
        .mb-10 {
            margin-bottom: 10px;
        }
        .dashboard-card {
            min-height: 130px;
        }
        .dashboard-card h2 {
            margin-top: 10px;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .traffic-info {
            margin-top: 15px;
        }
        .traffic-info p {
            font-size: 16px;
            margin-bottom: 10px;
        }
        .dashboard-value {
            font-size: 24px;
            font-weight: bold;
            display: block;
            margin-top: 15px;
        }
        .dashboard-traffic {
            font-size: 16px;
            font-weight: bold;
        }
        #network-status-badge {
            font-size: 14px;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="panel panel-default panel-intro">
        <div class="panel-heading">
            <div class="panel-lead"><em>网络监控面板</em>实时监控网络状态、性能与健康度</div>
        </div>
        
        <div class="panel-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="server-select">服务器</label>
                        <select id="server-select" class="form-control">
                            <option value="">请选择服务器</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="network-select">内网</label>
                        <select id="network-select" class="form-control" disabled>
                            <option value="">请先选择服务器</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-12 text-center">
                    <button id="load-data" class="btn btn-primary" disabled>加载数据</button>
                    <button id="refresh-data" class="btn btn-info" disabled>刷新数据</button>
                </div>
            </div>
            
            <div id="dashboard-content" style="display: none; margin-top: 20px;">
                <div class="row">
                    <div class="col-md-12">
                        <div class="alert alert-info">
                            <strong>当前监控:</strong> <span id="current-server"></span> - <span id="current-network"></span>
                            <span class="badge" id="network-status-badge"></span>
                        </div>
                    </div>
                </div>
                
                <!-- 状态卡片 -->
                <div class="row">
                    <div class="col-md-3">
                        <div class="panel panel-default dashboard-card">
                            <div class="panel-heading">
                                <h3 class="panel-title">平均响应时间</h3>
                            </div>
                            <div class="panel-body">
                                <div class="row">
                                    <div class="col-md-7">
                                        <span id="avg-response-time" class="dashboard-value">--</span>
                                    </div>
                                    <div class="col-md-5">
                                        <div id="response-time-mini-chart" style="height: 50px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="panel panel-default dashboard-card">
                            <div class="panel-heading">
                                <h3 class="panel-title">健康评分</h3>
                            </div>
                            <div class="panel-body">
                                <div class="row">
                                    <div class="col-md-7">
                                        <span id="health-score" class="dashboard-value">--</span>
                                    </div>
                                    <div class="col-md-5">
                                        <div id="health-score-mini-chart" style="height: 50px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="panel panel-default dashboard-card">
                            <div class="panel-heading">
                                <h3 class="panel-title">平均恢复时间</h3>
                            </div>
                            <div class="panel-body">
                                <div class="row">
                                    <div class="col-md-7">
                                        <span id="avg-recovery-time" class="dashboard-value">--</span>
                                    </div>
                                    <div class="col-md-5">
                                        <div id="recovery-time-mini-chart" style="height: 50px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="panel panel-default dashboard-card">
                            <div class="panel-heading">
                                <h3 class="panel-title">当前流量</h3>
                            </div>
                            <div class="panel-body">
                                <div class="row">
                                    <div class="col-md-12">
                                        <div>上传: <span id="upload-speed" class="dashboard-traffic">--</span></div>
                                        <div>下载: <span id="download-speed" class="dashboard-traffic">--</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 图表区域 -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <h3 class="panel-title">健康评分趋势</h3>
                            </div>
                            <div class="panel-body">
                                <div id="health-score-chart" style="height: 300px;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <h3 class="panel-title">网络中断趋势</h3>
                            </div>
                            <div class="panel-body">
                                <div id="disruption-trend-chart" style="height: 300px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 加载动画 -->
            <div id="loading-indicator" style="display: none; text-align: center; margin-top: 50px;">
                <i class="fa fa-spinner fa-spin fa-3x"></i>
                <p>加载数据中...</p>
            </div>
            
            <!-- 无数据提示 -->
            <div id="no-data-message" style="display: block; text-align: center; margin-top: 50px;">
                <i class="fa fa-info-circle fa-3x"></i>
                <p>请选择服务器和内网，然后点击"加载数据"按钮查看监控数据。</p>
            </div>
        </div>
    </div>

    <script src="__CDN__/assets/libs/jquery/dist/jquery.min.js"></script>
    <script src="__CDN__/assets/libs/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script>
        $(function () {
            // 声明图表变量
            var healthScoreChart, disruptionTrendChart;
            var responseMiniChart, healthMiniChart, recoveryMiniChart;
            
            // 初始化ECharts实例
            function initCharts() {
                // 主图表
                healthScoreChart = echarts.init(document.getElementById('health-score-chart'));
                disruptionTrendChart = echarts.init(document.getElementById('disruption-trend-chart'));
                
                // 迷你图表
                responseMiniChart = echarts.init(document.getElementById('response-time-mini-chart'));
                healthMiniChart = echarts.init(document.getElementById('health-score-mini-chart'));
                recoveryMiniChart = echarts.init(document.getElementById('recovery-time-mini-chart'));
                
                // 设置空白图表
                var emptyOption = {
                    grid: {
                        left: 0,
                        right: 0,
                        top: 0,
                        bottom: 0
                    },
                    xAxis: {
                        show: false,
                        type: 'category',
                        data: []
                    },
                    yAxis: {
                        show: false,
                        type: 'value'
                    },
                    series: [{
                        type: 'line',
                        data: [],
                        showSymbol: false,
                        smooth: true
                    }]
                };
                
                healthScoreChart.setOption(emptyOption);
                disruptionTrendChart.setOption(emptyOption);
                responseMiniChart.setOption(emptyOption);
                healthMiniChart.setOption(emptyOption);
                recoveryMiniChart.setOption(emptyOption);
            }
            
            // 加载服务器列表
            function loadServers() {
                $.ajax({
                    url: '{:url("tincui/networkdashboard/getServers")}',
                    type: 'GET',
                    dataType: 'json',
                    success: function(res) {
                        if (res.code === 1) {
                            var $select = $('#server-select');
                            $select.empty();
                            $select.append('<option value="">请选择服务器</option>');
                            
                            $.each(res.data, function(i, server) {
                                $select.append('<option value="' + server.id + '">' + server.name + '</option>');
                            });
                            
                            // 启用选择框
                            $select.prop('disabled', false);
                        } else {
                            Toastr.error(res.msg || '加载服务器列表失败');
                        }
                    },
                    error: function() {
                        Toastr.error('服务器连接失败，请检查网络');
                    }
                });
            }
            
            // 加载网络列表
            function loadNetworks(serverId) {
                $.ajax({
                    url: '{:url("tincui/networkdashboard/getNetworks")}',
                    type: 'GET',
                    data: { server_id: serverId },
                    dataType: 'json',
                    success: function(res) {
                        if (res.code === 1) {
                            var $select = $('#network-select');
                            $select.empty();
                            
                            if (res.data.length === 0) {
                                $select.append('<option value="">此服务器下无内网</option>');
                                $select.prop('disabled', true);
                                $('#load-data').prop('disabled', true);
                            } else {
                                $select.append('<option value="">请选择内网</option>');
                                
                                $.each(res.data, function(i, network) {
                                    $select.append('<option value="' + network.id + '">' + network.name + '</option>');
                                });
                                
                                // 启用选择框
                                $select.prop('disabled', false);
                            }
                        } else {
                            Toastr.error(res.msg || '加载内网列表失败');
                        }
                    },
                    error: function() {
                        Toastr.error('服务器连接失败，请检查网络');
                    }
                });
            }
            
            // 加载网络统计数据
            function loadNetworkStats(networkId) {
                // 显示加载指示器，隐藏其他内容
                $('#no-data-message').hide();
                $('#dashboard-content').hide();
                $('#loading-indicator').show();
                
                $.ajax({
                    url: '{:url("tincui/networkdashboard/getNetworkStats")}',
                    type: 'GET',
                    data: { network_id: networkId },
                    dataType: 'json',
                    success: function(res) {
                        $('#loading-indicator').hide();
                        
                        if (res.code === 1) {
                            // 显示仪表板内容
                            $('#dashboard-content').show();
                            
                            // 设置当前监控信息
                            var serverName = $('#server-select option:selected').text();
                            var networkName = $('#network-select option:selected').text();
                            $('#current-server').text(serverName);
                            $('#current-network').text(networkName);
                            
                            // 设置网络状态标签
                            var statusBadge = $('#network-status-badge');
                            if (res.data.network_status === '正常运行中') {
                                statusBadge.text('正常').removeClass('badge-danger badge-warning').addClass('badge-success');
                            } else if (res.data.network_status === '离线') {
                                statusBadge.text('离线').removeClass('badge-success badge-warning').addClass('badge-danger');
                            } else {
                                statusBadge.text(res.data.network_status).removeClass('badge-success badge-danger').addClass('badge-warning');
                            }
                            
                            // 更新卡片数据
                            $('#avg-response-time').text(res.data.avg_response_time + ' ms');
                            $('#health-score').text(res.data.health_score);
                            $('#avg-recovery-time').text(res.data.avg_recovery_time + ' 分钟');
                            $('#upload-speed').text(res.data.current_traffic.upload);
                            $('#download-speed').text(res.data.current_traffic.download);
                            
                            // 更新图表
                            updateCharts(res.data);
                            
                            // 启用刷新按钮
                            $('#refresh-data').prop('disabled', false);
                        } else {
                            $('#no-data-message').show();
                            Toastr.error(res.msg || '加载网络统计数据失败');
                        }
                    },
                    error: function() {
                        $('#loading-indicator').hide();
                        $('#no-data-message').show();
                        Toastr.error('服务器连接失败，请检查网络');
                    }
                });
            }
            
            // 更新图表
            function updateCharts(data) {
                // 健康评分趋势图
                var healthScoreOption = {
                    tooltip: {
                        trigger: 'axis'
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'category',
                        boundaryGap: false,
                        data: data.health_score_trend.dates
                    },
                    yAxis: {
                        type: 'value',
                        min: 0,
                        max: 100,
                        axisLabel: {
                            formatter: '{value}'
                        }
                    },
                    series: [{
                        name: '健康评分',
                        type: 'line',
                        data: data.health_score_trend.scores,
                        markLine: {
                            data: [
                                { type: 'average', name: '平均值' }
                            ]
                        },
                        itemStyle: {
                            color: '#36a2ef'
                        },
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(54, 162, 239, 0.5)' },
                                { offset: 1, color: 'rgba(54, 162, 239, 0.1)' }
                            ])
                        }
                    }]
                };
                
                // 网络中断趋势图
                var disruptionTrendOption = {
                    tooltip: {
                        trigger: 'axis'
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'category',
                        data: data.disruption_trend.dates
                    },
                    yAxis: {
                        type: 'value',
                        axisLabel: {
                            formatter: '{value} 次'
                        }
                    },
                    series: [{
                        name: '中断次数',
                        type: 'bar',
                        data: data.disruption_trend.counts,
                        itemStyle: {
                            color: '#ff6384'
                        }
                    }]
                };
                
                // 响应时间迷你图
                var responseMiniOption = {
                    grid: {
                        left: 0,
                        right: 0,
                        top: 0,
                        bottom: 0
                    },
                    xAxis: {
                        show: false,
                        type: 'category',
                        data: data.response_time_trend.dates
                    },
                    yAxis: {
                        show: false,
                        type: 'value'
                    },
                    series: [{
                        type: 'line',
                        data: data.response_time_trend.times,
                        showSymbol: false,
                        smooth: true,
                        lineStyle: {
                            width: 2,
                            color: '#4caf50'
                        }
                    }]
                };
                
                // 健康评分迷你图
                var healthMiniOption = {
                    grid: {
                        left: 0,
                        right: 0,
                        top: 0,
                        bottom: 0
                    },
                    xAxis: {
                        show: false,
                        type: 'category',
                        data: data.health_score_trend.dates
                    },
                    yAxis: {
                        show: false,
                        type: 'value'
                    },
                    series: [{
                        type: 'line',
                        data: data.health_score_trend.scores,
                        showSymbol: false,
                        smooth: true,
                        lineStyle: {
                            width: 2,
                            color: '#36a2ef'
                        }
                    }]
                };
                
                // 恢复时间迷你图
                var recoveryMiniOption = {
                    grid: {
                        left: 0,
                        right: 0,
                        top: 0,
                        bottom: 0
                    },
                    xAxis: {
                        show: false,
                        type: 'category',
                        data: data.recovery_time_trend.dates
                    },
                    yAxis: {
                        show: false,
                        type: 'value'
                    },
                    series: [{
                        type: 'line',
                        data: data.recovery_time_trend.times,
                        showSymbol: false,
                        smooth: true,
                        lineStyle: {
                            width: 2,
                            color: '#ff9800'
                        }
                    }]
                };
                
                // 应用图表配置
                healthScoreChart.setOption(healthScoreOption);
                disruptionTrendChart.setOption(disruptionTrendOption);
                responseMiniChart.setOption(responseMiniOption);
                healthMiniChart.setOption(healthMiniOption);
                recoveryMiniChart.setOption(recoveryMiniOption);
            }
            
            // 初始化
            function init() {
                // 初始化图表
                initCharts();
                
                // 加载服务器列表
                loadServers();
                
                // 窗口大小改变时重新调整图表大小
                $(window).resize(function() {
                    if (healthScoreChart) healthScoreChart.resize();
                    if (disruptionTrendChart) disruptionTrendChart.resize();
                    if (responseMiniChart) responseMiniChart.resize();
                    if (healthMiniChart) healthMiniChart.resize();
                    if (recoveryMiniChart) recoveryMiniChart.resize();
                });
                
                // 服务器选择事件
                $('#server-select').change(function() {
                    var serverId = $(this).val();
                    
                    // 重置网络选择和按钮状态
                    $('#network-select').empty().append('<option value="">请先选择服务器</option>').prop('disabled', true);
                    $('#load-data, #refresh-data').prop('disabled', true);
                    
                    // 隐藏仪表板内容，显示提示信息
                    $('#dashboard-content').hide();
                    $('#no-data-message').show();
                    
                    if (serverId) {
                        loadNetworks(serverId);
                    }
                });
                
                // 网络选择事件
                $('#network-select').change(function() {
                    var networkId = $(this).val();
                    $('#load-data').prop('disabled', !networkId);
                    $('#refresh-data').prop('disabled', true);
                });
                
                // 加载数据按钮点击事件
                $('#load-data').click(function() {
                    var networkId = $('#network-select').val();
                    if (networkId) {
                        loadNetworkStats(networkId);
                    }
                });
                
                // 刷新数据按钮点击事件
                $('#refresh-data').click(function() {
                    var networkId = $('#network-select').val();
                    if (networkId) {
                        loadNetworkStats(networkId);
                    }
                });
            }
            
            // 初始化页面
            init();
        });
    </script>
</body>
</html> 